name: Build
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  init:
    name: Init
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        run: npm ci

  build-and-scan:
    name: Build and Scan
    needs: init
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Restore npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: SonarQube Scan
        if: ${{ secrets.SONAR_TOKEN }}
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  deploy-integration:
    name: Deploy Integration
    needs: build-and-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to integration (placeholder)
        run: |
          echo "Deploying to integration environment..."
          echo "Replace this step with your real deployment commands or actions."

  integration-test:
    name: Integration Test
    needs: deploy-integration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests (if defined)
        run: |
          if node -e "process.exit(Boolean(require('./package.json').scripts && require('./package.json').scripts['test:integration'])?0:1)"; then
            npm run test:integration
          else
            echo "No integration test script defined; skipping."
          fi

  cleanup-integration:
    name: Clean Up Integration
    needs: integration-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clean up integration environment (placeholder)
        run: |
          echo "Cleaning up integration environment..."
          echo "Replace this step with commands to tear down your integration deployment."

  create-tag:
    name: Create Tag
    needs: integration-test
    if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.integration-test.result == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TAG="release-$(date +'%Y%m%d%H%M%S')"
          echo "Creating tag $TAG"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "CI: create tag $TAG"
          git push origin "$TAG"